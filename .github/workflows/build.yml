name: CI - Build Linux & Windows

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      # --- LINUX SETUP ---
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y qt6-base-dev qt6-declarative-dev cmake ninja-build pkg-config
          echo "QT_QMAKE_EXECUTABLE=$(which qmake6 || which qmake)" >> $GITHUB_ENV

      # --- WINDOWS SETUP ---
      - name: Install Qt (Windows)
        if: matrix.os == 'windows-latest'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          arch: 'win64_msvc2019_64'
          # This action automatically adds Qt bin to PATH and sets env vars

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      # --- BUILD ---
      - name: Build (release)
        run: cargo build --release

      # --- PACKAGE LINUX ---
      - name: Package (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get install -y p7zip-full upx-ucl pixz
          
          mkdir -p artifact
          cp target/release/supervtf artifact/
          cp -r qml media resources.qrc artifact/ || true

          # Safe to UPX binary on Linux
          upx --best --lzma artifact/supervtf || echo "UPX skipped"

          cd artifact && tar -cf ../payload.tar * && cd ..
          pixz -9 payload.tar payload.tar.xz

          printf '%s\n' '#!/bin/bash' '# SuperVTF Self-Extracting Launcher' 'TMPDIR=$(mktemp -d /tmp/supervtf.XXXXXX)' 'ARCHIVE_START=$(awk '"'"'/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }'"'"' "$0")' 'tail -n+$ARCHIVE_START "$0" | xz -d | tar -xf - -C "$TMPDIR"' 'cd "$TMPDIR"' './supervtf "$@"' 'EXIT_CODE=$?' 'cd /' 'rm -rf "$TMPDIR"' 'exit $EXIT_CODE' '__ARCHIVE_BELOW__' > supervtf-launcher.sh
          cat payload.tar.xz >> supervtf-launcher.sh
          chmod +x supervtf-launcher.sh
          mv supervtf-launcher.sh supervtf-linux

      # --- PACKAGE WINDOWS (FIXED) ---
      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # 1. Install Tools
          choco install upx 7zip -y
          
          # 2. Prepare Directory
          $artifactDir = "artifact"
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null
          
          $exeSource = "target\release\supervtf.exe"
          if (-not (Test-Path $exeSource)) { throw "Executable not found at $exeSource" }
          Copy-Item $exeSource -Destination $artifactDir
          
          # 3. Copy QML/Resources (Important for windeployqt to find imports)
          if (Test-Path "qml") { Copy-Item "qml" -Destination $artifactDir -Recurse }
          if (Test-Path "media") { Copy-Item "media" -Destination $artifactDir -Recurse }

          # 4. Run Windeployqt
          # Since install-qt-action puts Qt in PATH, we usually don't need full paths.
          # However, to be safe, we use the env var it provides ($env:IQTA_TOOLS_ROOT is sometimes set, 
          # but simply calling windeployqt usually works if the previous step succeeded).
          Write-Host "Running windeployqt..."
          # Keep it verbose and explicitly include the platforms plugin
          windeployqt --dir $artifactDir --qmldir qml --plugins platforms --no-translations --no-compiler-runtime --no-system-d3d-compiler --no-opengl-sw --verbose=1 --release "$artifactDir\supervtf.exe"

          # 5. Clean up bloat
          if (Test-Path "$artifactDir\opengl32sw.dll") { Remove-Item "$artifactDir\opengl32sw.dll" }
          # Remove .pdb files if any copied
          Get-ChildItem $artifactDir -Filter *.pdb -Recurse | Remove-Item

          # 6. Verify Critical DLL (Sanity Check)
          if (-not (Test-Path "$artifactDir\Qt6Core.dll")) { throw "Qt6Core.dll missing! Windeployqt failed." }

          # Confirm qwindows.dll presence, otherwise attempt targeted fallback search and copy
          if (-not (Test-Path "$artifactDir\plugins\platforms\qwindows.dll")) {
            Write-Host "qwindows.dll not found in $artifactDir\plugins\platforms. Printing plugin dirs and attempting fallback search..."
            $qtBin = $env:QT_BIN
            Write-Host "QT_BIN = $qtBin"
            $candidates = @(
              (Join-Path $qtBin '..\plugins\platforms'),
              (Join-Path $qtBin '..\..\plugins\platforms'),
              "C:\Qt\6.6.3\msvc2019_64\plugins\platforms",
              "C:\HostedToolCache\windows\Qt\6.6.3\msvc2019_64\plugins\platforms",
              "D:\a\SuperVTF\Qt\6.6.3\msvc2019_64\plugins\platforms",
              "D:\a\_temp"
            )
            foreach ($cand in $candidates) {
              if (Test-Path $cand) { Write-Host "Candidate path exists: $cand"; Get-ChildItem -Path $cand -Filter qwindows.dll -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  -> $_.FullName" } } else { Write-Host "Candidate path does not exist: $cand" }
            }

            # Perform a focused runner search for qwindows.dll in likely tool cache and agent paths
            $searchRoots = @("D:\a", "C:\HostedToolCache", "C:\Qt")
            $foundPaths = @()
            foreach ($root in $searchRoots) {
              if (Test-Path $root) {
                Write-Host "Searching $root for qwindows.dll..."
                $hits = Get-ChildItem -Path $root -Filter qwindows.dll -Recurse -ErrorAction SilentlyContinue -Force -File | Select-Object -ExpandProperty FullName -ErrorAction SilentlyContinue
                if ($hits) { $foundPaths += $hits }
              }
            }
            if ($foundPaths.Count -gt 0) {
              Write-Host "Found qwindows.dll at:"
              $foundPaths | ForEach-Object { Write-Host " - $_" }
              $source = $foundPaths[0]
              New-Item -ItemType Directory -Force -Path (Join-Path $artifactDir 'plugins\platforms') | Out-Null
              Copy-Item -Path $source -Destination (Join-Path $artifactDir 'plugins\platforms') -Force
              Write-Host "Copied $source to artifact/plugins/platforms"
            } else {
              Write-Host "qwindows.dll not found in search roots. Listing artifact for debugging:"
              Get-ChildItem -Path $artifactDir -Recurse | ForEach-Object { Write-Host $_.FullName }
              throw "qwindows.dll missing! Windeployqt failed and no fallback copy found."
            }
          }

          # 7. Compress ONLY the Executable (NEVER compress DLLs)
          Write-Host "Compressing EXE..."
          upx --best --lzma --force "$artifactDir\supervtf.exe"

          # 8. Create SFX with 7-Zip
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $sfxModule = "C:\Program Files\7-Zip\7z.sfx"
          
          # Create archive of the artifact FOLDER contents
          & $7zPath a -t7z -m0=lzma2 -mx=9 -mfb=273 -ms=on "payload.7z" ".\$artifactDir\*"

          # Create Config
          # REMOVED InstallPath="C:\\tmp" to allow default temp behavior
          $configLines = @(
            ';!@Install@!UTF-8!',
            'Title="SuperVTF"',
            'GUIMode="2"',            
            'OverwriteMode="0"',      # 0=Overwrite all using temp names (safer for temp runs)
            'RunProgram="supervtf.exe"',
            ';!@InstallEnd@!'
          )
          $configLines -join "`r`n" | Set-Content -Path config.txt -NoNewline

          # Merge
          cmd /c "copy /b `"$sfxModule`" + config.txt + payload.7z supervtf-portable.exe"

      # --- UPLOADS ---
      - name: Upload artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: supervtf-linux
          path: supervtf-linux

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: supervtf-windows-portable
          path: supervtf-portable.exe